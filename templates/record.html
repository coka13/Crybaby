<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="http://127.0.0.1:5000/static/styles.css">
  <link rel="stylesheet" href="https://cdn.korzh.com/metroui/v4.5.1/css/metro-all.min.css">
  <link rel="icon" type="image/png" href="static/favicon.ico">
  <script src="https://cdn.korzh.com/metroui/v4.5.1/js/metro.min.js"></script>
  <title>Record</title>

</head>
<body class="background">


  <aside class="sidebar pos-absolute z-2" data-role="sidebar" data-toggle="#sidebar-toggle-3" id="sb3" data-shift=".shifted-content" >
    <div class="sidebar-header" data-image="images/sb-bg-1.jpg">
      <div class="avatar"></div>
      <span class="title fg-black">Crybaby</span>
    </div>
    <ul class="sidebar-menu">
      <li><a href="/home"><span class="mif-home icon"></span>Home</a></li>
      <li><a href="/upload"><span class="mif-file-upload icon"></span>Upload</a></li>
      <li><a href="/record"><span class="mif-record_voice_over icon"></span>Record</a></li>
      <li><a href="/history"><span class="mif-history icon"></span>History</a></li>
      <li><a href="/newborns"><span class="mif-organization icon"></span>Newborns</a></li>
      <li><a href="/user"><span class="mif-user icon"></span>User</a></li>
      <li><a href="/logout"><span class="mif-exit icon"></span>Logout</a></li>
    </ul>
  </aside>
  <div class="shifted-content h-100 p-ab">
    <div class="app-bar pos-absolute bg-red z-1" data-role="appbar">
        <button class="app-bar-item c-pointer" id="sidebar-toggle-3">
            <span class="mif-menu fg-white"></span>
        </button>
    </div>

    <div class="h-100 p-4">
        <p>
          <div class="remark alert">
            <h3>Make a new recording</h3>
              <!-- HTML form for recording audio -->
                <form action="/record" id="recordForm" method="post" enctype="multipart/form-data">
                <!--input type="button" value="Record" id="recordButton">
                <input type="hidden" id="audioData" name="record_file">
                <input type="button" value="Submit" id="submitButton" style="display: none;"-->
                <button id="startRecording">Start recording</button>
                <button id="stopRecording" disabled>Stop recording</button>
                <button id="downloadAudio" disabled>Stop recording</button>

               </form>
              <audio controls id="audioPlayer"></audio>
  
            <script>
                navigator
                    .mediaDevices
                    .getUserMedia({audio: true})
                    .then(stream => { handlerFunction(stream) });

                function handlerFunction(stream) {
                    rec = new MediaRecorder(stream);
                    rec.ondataavailable = e => {
                        audioChunks.push(e.data);
                        if (rec.state == "inactive") {
                            let blob = new Blob(audioChunks, {'type': 'audio/ogg; codecs=opus'});
                            sendData(blob);

                        }
                    }
                }

                function sendData(data) {
                    var form = new FormData();
                    const duration = Math.ceil(data.size / (44100 * 2 * 1)); 
                    document.getElementById('audioPlayer').setAttribute('duration', duration);
                    form.append('file', data, 'data.ogg');
                    form.append('title', 'data.ogg');
                    form.append('duration', duration);
                    //Chrome inspector shows that the post data includes a file and a title.
                    fetch('/record', {method: 'POST', body: form})
                    .then(response => {
                    console.log(response); });                             
                   }

                   let recTimeout;

                    startRecording.onclick = e => {
                    console.log('Recording has started..');
                    startRecording.disabled = true;
                    stopRecording.disabled = false;
                    audioChunks = [];
                    rec.start();
                    recTimeout = setTimeout(() => {
                    stopRecording.click();
                          }, 7000);
                      };

                      stopRecording.onclick = e => {
                      console.log("Recording has stopped.");
                      startRecording.disabled = false;
                      stopRecording.disabled = true;
                      rec.stop();
                          clearTimeout(recTimeout);
                      };

                      const downloadAudio = () => {
                      const downloadLink = document.createElement('a')
                      downloadLink.href = audioURL
                      downloadLink.setAttribute('download', 'audio')
                      downloadLink.click()
                  }
              </script>
          </div>
        </p>
      </div>
  
      // Call the startRecording function when the page loads
      window.onload = startRecording;
    
  </body>
</html>
  

 
  

  <!-- <script>
    // Function to start recording audio
    function startRecording() {
      let recordButton = document.getElementById('recordButton');
      let submitButton = document.getElementById('submitButton');
      let audioDataInput = document.getElementById('audioData');
      let recordForm = document.getElementById('recordForm');
      let audioPlayer = document.getElementById('audioPlayer');
      
      if (recordButton && submitButton && audioDataInput && recordForm && audioPlayer) {
        // Declare global variables for MediaRecorder instance and recorded data chunks
        let mediaRecorder;
        let chunks = [];
  
        // Reset recorded data chunks
        chunks = [];
  
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(function(stream) {
            // Create a MediaRecorder instance
            mediaRecorder = new MediaRecorder(stream);
  
            // Start recording when the record button is clicked
            recordButton.addEventListener('click', function() {
              mediaRecorder.start();
              console.log('Recording started');
              // Automatically stop recording after 7 seconds
              setTimeout(function() {
                mediaRecorder.stop();
              }, 7000);
            });
  
            // Stop recording and update the form data when the submit button is clicked
            submitButton.addEventListener('click', function() {
              console.log('Recording stopped');
              audioDataInput.value = JSON.stringify(chunks);
              
              // Convert chunks to Blob
              let blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
              
              // Create FormData object to send file data as multipart/form-data
              let formData = new FormData();
              formData.append('record_file', blob, 'recorded_audio.wav');

              // Send POST request to Flask endpoint with file data as payload
              fetch('http://127.0.0.1:5000/record', {  // Update the endpoint URL to match your backend Flask endpoint for handling file uploads
                method: 'POST',
                body: formData
              })
              .then(response => {
                // Handle response from server
                if (response.ok) {
                  // Handle successful response
                  // You can add your own logic here based on the response from the server
                } else {
                  // Handle unsuccessful response
                  // You can add your own error handling logic here
                }
              })
              .catch(error => {
                console.error('Error sending request:', error);
              });

              // Submit the form
              recordForm.submit();
            });
  
            // Save recorded chunks of data
            mediaRecorder.addEventListener('dataavailable', function(event) {
              chunks.push(event.data);
            });
  
            // Play recorded audio
            mediaRecorder.addEventListener('stop', function() {
              let blob = new Blob(chunks, { type: 'audio/ogg; codecs=opus' });
              audioPlayer.src = URL.createObjectURL(blob);
              audioPlayer.controls = true;
              // Show the submit button after recording is finished
              submitButton.style.display = 'inline';
            });
          })
          .catch(function(error) {
            console.error('Error accessing microphone:', error);
          });
      }
    } -->
  
 
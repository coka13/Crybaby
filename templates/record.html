<!DOCTYPE html>
<html>
<head>
  {% include 'links.html' %}
  <a href="{{ url_for('record.record') }}"></a>
  <title>Record</title>
</head>
<body class="background">
  <div class="h-100 p-4">
    {% include 'navbar.html' %}
    <div id="medCard">
      <div id="card-content">
      <div class="recForm">
          <div id="card-title">
            <h2>Make a new recording</h2>
          </div>
            <!-- HTML form for recording audio -->
            <form action="/record" method="post" enctype="multipart/form-data">
               <button id="startRecording" onclick="toggleRecording()"><i class="fa fa-microphone"></i></button>
              <button id="stopRecording" disabled><i class="fa fa-stop"></i></button>
              <br>
              <label for="newborn-name" style="padding-top:13px; font-weight: bold;">&nbsp;Pick a newborn</label>
              <br>
              <select name="newborn_name">
                {% for n in newborns %}
                <option value="{{ n['name'] }}">{{ n['name'] }}</option>
                {% endfor %}
              </select>
              <br>
              <br>
              <label for="recording_name" style="padding-top:13px; font-weight: bold;">&nbsp;Name your recording</label>
              <br>
              <input id="recording_name" class="form-content" type="text"  autocomplete="on" required />
              <div class="form-border"></div>
              </form>
              <div id="prediction-result"></div>
              {% if result is defined %}
              <div>
                <h3>Prediction Result:</h3>
                <p><strong>The prediction is:</strong> {{ result }}</p>
              </div>
              {% endif %}
          </div>
      </div>
    </div>
    </div>
  </div>
  <script>
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => { handlerFunction(stream) });

    function handlerFunction(stream) {
      rec = new MediaRecorder(stream);
      rec.ondataavailable = e => {
        audioChunks.push(e.data);
        if (rec.state == "inactive") {
          let blob = new Blob(audioChunks);
          sendData(blob);
        }
      }
    }

    function sendData(data) {
      const form = new FormData(document.querySelector('form'));
      const newbornName = document.querySelector('select[name="newborn_name"]').value;
      const recordingName = document.querySelector('input[name="recording_name"]').value;
      form.append('newborn_name', newbornName);
      form.append('recording_name', recordingName);
      form.append('file', data, 'data');
      fetch('/record', { method: 'POST', body: form })
        .then(response => response.text())
        .then(result => {
          document.getElementById('prediction-result').textContent = result;
          console.log(result);
        })
        .catch(error => {
          console.error('Error:', error);
        });
    }

    let recTimeout;
    startRecording.onclick = e => {
      console.log('Recording has started..');
      startRecording.disabled = true;
      stopRecording.disabled = false;
      audioChunks = [];
      rec.start();
      recTimeout = setTimeout(() => {
        stopRecording.click();
      }, 7500);
    };

    stopRecording.onclick = e => {
      console.log("Recording has stopped.");
      startRecording.disabled = false;
      stopRecording.disabled = true;
      rec.stop();
      clearTimeout(recTimeout);
    };                                                       
  </script>
</body>
</html>
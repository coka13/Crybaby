<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="http://127.0.0.1:5000/static/styles.css">
  <link rel="stylesheet" href="https://cdn.korzh.com/metroui/v4.5.1/css/metro-all.min.css">
  <link rel="icon" type="image/png" href="static/favicon.ico">
  <script src="https://cdn.korzh.com/metroui/v4.5.1/js/metro.min.js"></script>
  <a href="{{ url_for('record.record') }}"></a>
  <title>Record</title>

</head>
<body class>


  <aside class="sidebar pos-absolute z-2" data-role="sidebar" data-toggle="#sidebar-toggle-3" id="sb3" data-shift=".shifted-content" >
    <div class="sidebar-header" data-image="images/sb-bg-1.jpg">
      <div class="avatar"></div>
      <span class="title fg-black">Crybaby</span>
    </div>
    <ul class="sidebar-menu">
      <li><a href="/home"><span class="mif-home icon"></span>Home</a></li>
      <li><a href="/upload"><span class="mif-file-upload icon"></span>Upload</a></li>
      <li><a href="/record"><span class="mif-record_voice_over icon"></span>Record</a></li>
      <li><a href="/history"><span class="mif-history icon"></span>History</a></li>
      <li><a href="/newborns"><span class="mif-organization icon"></span>Newborns</a></li>
      <li><a href="/user"><span class="mif-user icon"></span>User</a></li>
      <li><a href="/logout"><span class="mif-exit icon"></span>Logout</a></li>
    </ul>
  </aside>
  <div class="shifted-content h-100 p-ab">
    <div class="app-bar pos-absolute bg-red z-1" data-role="appbar">
        <button class="app-bar-item c-pointer" id="sidebar-toggle-3">
            <span class="mif-menu fg-white"></span>
        </button>
    </div>

    <div class="h-100 p-4">
          <div id="record-form">
            <p>
          <div class="remark alert">
            <h3>Make a new recording</h3>
              <!-- HTML form for recording audio -->
                <form action="/record"  method="post" enctype="multipart/form-data">
                <button id="startRecording">Start recording</button>
                <button id="stopRecording" disabled>Stop recording</button>

                <select name="newborn_name">
                  {% for n in newborns %}
                  <option value="{{ n['name'] }}">{{ n['name'] }}</option>
                  {% endfor %}
                </select>
                <input type="text" name="recording_name" placeholder="Enter recording name">
               </form>
               {% if result is defined %}
               <div>
                 <h3>Prediction Result:</h3>
                 <p>{{ result }}</p>
               </div>
             {% endif %}
             </p>
  
          </div>
      </div>
      <script>
        navigator
            .mediaDevices
            .getUserMedia({audio: true})
            .then(stream => { handlerFunction(stream) });

        function handlerFunction(stream) {
            rec = new MediaRecorder(stream);
            rec.ondataavailable = e => {
                audioChunks.push(e.data);
                if (rec.state == "inactive") {
                  let blob = new Blob(audioChunks);
                    sendData(blob);

                }
            }
        }

        function sendData(data) {
          const form = new FormData(document.querySelector('form'));
          const newbornName = document.querySelector('select[name="newborn_name"]').value;
          const recordingName = document.querySelector('input[name="recording_name"]').value;
          form.append('newborn_name', newbornName);
          form.append('recording_name', recordingName);
          form.append('file', data, 'data');
          fetch('/record', { method: 'POST', body: form })
            .then(response => {
              console.log(response);
            });
        }

           let recTimeout;

            startRecording.onclick = e => {
            console.log('Recording has started..');
            startRecording.disabled = true;
            stopRecording.disabled = false;
            audioChunks = [];
            rec.start();
            recTimeout = setTimeout(() => {
            stopRecording.click();
                  }, 7500);
              };

              stopRecording.onclick = e => {
              console.log("Recording has stopped.");
              startRecording.disabled = false;
              stopRecording.disabled = true;
              rec.stop();
                  clearTimeout(recTimeout);
              };                                                       
      </script>
  </body>
</html>